name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  validate-version:
    name: ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract.outputs.version }}
    steps:
      - uses: actions/checkout@v6

      - name: ã‚¿ã‚°ã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŠ½å‡º
        id: extract
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $VERSION"

      - name: ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
        run: |
          VERSION=${{ steps.extract.outputs.version }}
          
          # package.json
          PKG_VERSION=$(node -p "require('./chrome-extension/package.json').version")
          if [ "$PKG_VERSION" != "$VERSION" ]; then
            echo "âŒ package.json ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ ($PKG_VERSION) ãŒã‚¿ã‚° ($VERSION) ã¨ä¸€è‡´ã—ã¾ã›ã‚“"
            exit 1
          fi
          echo "âœ… package.json: $PKG_VERSION"
          
          # manifest.json
          MANIFEST_VERSION=$(node -p "require('./chrome-extension/manifest.json').version")
          if [ "$MANIFEST_VERSION" != "$VERSION" ]; then
            echo "âŒ manifest.json ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ ($MANIFEST_VERSION) ãŒã‚¿ã‚° ($VERSION) ã¨ä¸€è‡´ã—ã¾ã›ã‚“"
            exit 1
          fi
          echo "âœ… manifest.json: $MANIFEST_VERSION"
          
          # pyproject.toml
          PYPROJECT_VERSION=$(grep -E '^version\s*=' pyproject.toml | sed 's/version\s*=\s*"\([^"]*\)"/\1/')
          if [ "$PYPROJECT_VERSION" != "$VERSION" ]; then
            echo "âŒ pyproject.toml ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ ($PYPROJECT_VERSION) ãŒã‚¿ã‚° ($VERSION) ã¨ä¸€è‡´ã—ã¾ã›ã‚“"
            exit 1
          fi
          echo "âœ… pyproject.toml: $PYPROJECT_VERSION"
          
          echo ""
          echo "ğŸ‰ å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒä¸€è‡´ã—ã¦ã„ã¾ã™: $VERSION"

  build-extension:
    name: Chromeæ‹¡å¼µãƒ“ãƒ«ãƒ‰
    needs: validate-version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v6
        with:
          node-version: '24.13.0'
          cache: 'npm'
          cache-dependency-path: chrome-extension/package-lock.json

      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        working-directory: chrome-extension
        run: npm ci

      - name: ãƒ“ãƒ«ãƒ‰
        working-directory: chrome-extension
        run: npm run build

      - name: ZIPãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä½œæˆ
        working-directory: chrome-extension
        run: |
          cd dist
          zip -r ../yayoi-next-bridge-${{ needs.validate-version.outputs.version }}.zip .

      - name: ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: chrome-extension
          path: chrome-extension/yayoi-next-bridge-${{ needs.validate-version.outputs.version }}.zip

  create-release:
    name: GitHubãƒªãƒªãƒ¼ã‚¹ä½œæˆ
    needs: [validate-version, build-extension]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v4
        with:
          name: chrome-extension
          path: ./artifacts

      - name: CHANGELOGã‹ã‚‰ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’æŠ½å‡º
        id: changelog
        run: |
          # Unreleasedã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¾ãŸã¯è©²å½“ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æŠ½å‡º
          VERSION=${{ needs.validate-version.outputs.version }}
          
          # CHANGELOGã‹ã‚‰ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’æŠ½å‡ºï¼ˆç°¡æ˜“ç‰ˆï¼‰
          if grep -q "## \[$VERSION\]" CHANGELOG.md; then
            # è©²å½“ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æŠ½å‡º
            sed -n "/## \[$VERSION\]/,/## \[/p" CHANGELOG.md | head -n -1 > release_notes.md
          else
            # Unreleasedã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨
            sed -n '/## \[Unreleased\]/,/## \[/p' CHANGELOG.md | head -n -1 > release_notes.md
          fi
          
          # ç©ºã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          if [ ! -s release_notes.md ]; then
            echo "v$VERSION ãƒªãƒªãƒ¼ã‚¹" > release_notes.md
          fi
          
          cat release_notes.md

      - name: GitHubãƒªãƒªãƒ¼ã‚¹ä½œæˆ
        uses: softprops/action-gh-release@v2
        with:
          name: v${{ needs.validate-version.outputs.version }}
          body_path: release_notes.md
          files: |
            artifacts/yayoi-next-bridge-${{ needs.validate-version.outputs.version }}.zip
          draft: false
          prerelease: ${{ contains(needs.validate-version.outputs.version, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
